<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æ•¸è³“æœ v5.0.0 - è€å¸«ç«¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 0.5em;
        }
        .fraction > span {
            display: block;
            padding: 0 0.3em;
        }
        .fraction > span.denominator {
            border-top: 2px solid currentColor;
        }
        /* --- ğŸ¨ å¯ä¿®æ”¹å€åŸŸï¼šéª°å­å¤–è§€ --- */
        .dice {
            width: 100px;
            height: 100px;
            border-radius: 16px;
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: bold;
            color: #1f2937;
        }
        /* --- ğŸ¨ å¯ä¿®æ”¹å€åŸŸçµæŸ --- */
        .history-item {
            font-size: 2rem;
            padding: 0.5rem 1rem;
            background-color: #f3f4f6;
            border-radius: 8px;
        }
        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(15deg) scale(1.05); }
            50% { transform: rotate(-15deg) scale(1.05); }
            75% { transform: rotate(5deg) scale(1.02); }
            100% { transform: rotate(0deg) scale(1); }
        }
        .rolling {
            animation: roll 0.2s linear infinite;
        }
        /* v5.0.0: æ…¶ç¥å½ˆå‡ºè¦–çª—æ¨£å¼ */
        #celebration-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        #celebration-content {
            background-color: white;
            padding: 2rem;
            border-radius: 24px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: scale(0.5);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        #celebration-modal.visible #celebration-content {
            transform: scale(1);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="room-entry-container" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-8 text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-6">åˆ†æ•¸è³“æœ - æ•™å®¤è¨­å®š</h1>
            <p class="text-gray-600 mb-4">è«‹ç‚ºæ‚¨çš„æ•™å®¤å‘½åï¼Œä¾‹å¦‚ã€Œ502ã€æˆ–ã€Œé€±ä¸‰æ•¸å­¸ç­ã€ã€‚</p>
            <input type="text" id="room-id-input" placeholder="è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
            <button id="enter-room-btn" class="w-full mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition-transform transform active:scale-95 shadow-md">
                âœ… å»ºç«‹/é€²å…¥æ•™å®¤
            </button>
        </div>
    </div>

    <div id="main-game-content" class="min-h-screen" style="display: none;">
        <div class="flex flex-col md:flex-row h-screen">
            
            <div id="bingo-winners-area" class="w-full md:w-1/4 bg-green-50 p-6 border-r border-gray-200 flex flex-col">
                <h2 class="text-2xl font-bold text-green-700 text-center mb-4">ğŸ† å®Œæˆè³“æœ ğŸ†</h2>
                <div id="winners-list" class="flex-grow bg-white rounded-lg p-4 shadow-inner overflow-y-auto">
                    <p class="text-gray-400 text-center">ç›®å‰æ²’æœ‰äººè³“æœ...</p>
                </div>
            </div>

            <div id="teacher-controls-area" class="w-full md:w-1/2 p-6 md:p-8 flex flex-col items-center justify-center">
                <div class="w-full max-w-lg text-center">
                    <h1 class="text-3xl md:text-4xl font-bold text-blue-600 mb-2">åˆ†æ•¸è³“æœ - è€å¸«ç«¯</h1>
                    <h2 id="classroom-display" class="text-xl font-semibold text-gray-500 mb-4"></h2>
                    <button id="roll-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition-transform transform active:scale-95 shadow-md">
                        ğŸ² æ“²éª°å­
                    </button>

                    <div class="flex flex-col items-center justify-center space-y-4 my-8">
                        <div class="flex items-center space-x-4">
                            <div id="dice1" class="dice">?</div>
                            <div id="dice2" class="dice">?</div>
                        </div>
                        <div id="fraction-display" class="text-7xl md:text-9xl font-bold text-gray-700 h-32 md:h-40 flex items-center"></div>
                    </div>

                    <div id="visualization-container" class="grid grid-cols-2 md:grid-cols-3 gap-4 min-h-[150px] border-t pt-6">
                        <div class="col-span-full flex items-center justify-center text-gray-400">
                            <p>ğŸ’¡ æ“²å‡ºéª°å­å¾Œï¼Œé€™è£¡æœƒé¡¯ç¤ºç­‰å€¼åˆ†æ•¸çš„åœ–å½¢æç¤º</p>
                        </div>
                    </div>
                     <div class="mt-8 border-t pt-6">
                        <h2 class="text-2xl font-bold text-center mb-4">ğŸ“œ æ­·å²ç´€éŒ„</h2>
                        <div id="history-container" class="flex flex-wrap justify-center gap-4 p-4 bg-gray-50 rounded-lg min-h-[80px]">
                            <p class="text-gray-400">ç›®å‰æ²’æœ‰ç´€éŒ„</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="student-status-area" class="w-full md:w-1/4 bg-blue-50 p-6 border-l border-gray-200 flex flex-col">
                <h2 class="text-2xl font-bold text-blue-700 text-center mb-4">ğŸ‘¨â€ğŸ“ æ•™å®¤å­¸ç”Ÿ ğŸ‘©â€ğŸ“</h2>
                <div id="student-list" class="flex-grow bg-white rounded-lg p-4 shadow-inner overflow-y-auto">
                    <p class="text-gray-400 text-center">æ­£åœ¨ç­‰å¾…å­¸ç”ŸåŠ å…¥...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="celebration-modal">
        <div id="celebration-content">
            <img id="celebration-image" src="https://class.kh.edu.tw/sites/26005/upload_file/6/21.png" alt="Bingo!" class="w-64 h-64 mx-auto mb-4">
            <h2 id="celebration-text" class="text-3xl font-bold text-yellow-500"></h2>
            <button id="close-celebration-btn" class="mt-6 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">é—œé–‰</button>
        </div>
    </div>


    <audio id="roll-sound" src="https://taira-komori.net/sound_os2/daily01/rolling_pencil.mp3" preload="auto"></audio>
    <audio id="bingo-sound" src="https://taira-komori.net/sound_os/pre/trumpet1.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // ===== Firebase è¨­å®š =====
        const firebaseConfig = {
          apiKey: "AIzaSyCS-PnLcCou_7-PHWu0i-iQLuZz5dh-Rps",
          authDomain: "fraction-bingo-game.firebaseapp.com",
          projectId: "fraction-bingo-game",
          databaseURL: "https://fraction-bingo-game-default-rtdb.asia-southeast1.firebasedatabase.app",
          storageBucket: "fraction-bingo-game.firebasestorage.app",
          messagingSenderId: "542920141931",
          appId: "1:542920141931:web:999d100aafa817a6ff152e"
        };
        // ========================

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- DOM å…ƒç´  ---
        const roomEntryContainer = document.getElementById('room-entry-container');
        const mainGameContent = document.getElementById('main-game-content');
        const roomIdInput = document.getElementById('room-id-input');
        const enterRoomBtn = document.getElementById('enter-room-btn');
        const classroomDisplay = document.getElementById('classroom-display');
        const rollButton = document.getElementById('roll-button');
        const dice1El = document.getElementById('dice1');
        const dice2El = document.getElementById('dice2');
        const fractionDisplayEl = document.getElementById('fraction-display');
        const visualizationContainerEl = document.getElementById('visualization-container');
        const historyContainerEl = document.getElementById('history-container');
        const rollSound = document.getElementById('roll-sound');
        // v5.0.0: æ–°å¢ DOM å…ƒç´ 
        const studentListEl = document.getElementById('student-list');
        const winnersListEl = document.getElementById('winners-list');
        const celebrationModal = document.getElementById('celebration-modal');
        const celebrationText = document.getElementById('celebration-text');
        const closeCelebrationBtn = document.getElementById('close-celebration-btn');
        const bingoSound = document.getElementById('bingo-sound');


        // --- éŠæˆ²ç‹€æ…‹ ---
        let classRoomId = null;
        let history = [];
        // v5.0.0: ç”¨æ–¼è¿½è¹¤å·²æ…¶ç¥éçš„è³“æœç©å®¶
        let celebratedWinners = new Set(); 

        // --- äº‹ä»¶ç›£è½ ---
        enterRoomBtn.addEventListener('click', enterRoom);
        rollButton.addEventListener('click', rollDice);
        closeCelebrationBtn.addEventListener('click', () => {
            celebrationModal.classList.remove('visible');
            setTimeout(() => { celebrationModal.style.display = 'none'; }, 300);
        });
        
        // --- æ ¸å¿ƒå‡½å¼ ---
        function enterRoom() {
            const roomId = roomIdInput.value.trim();
            if (!roomId) {
                alert('è«‹å‹™å¿…è¼¸å…¥æ•™å®¤ä»£ç¢¼ï¼');
                return;
            }
            classRoomId = roomId;
            
            // v5.0.0: é€²å…¥æ•™å®¤æ™‚ï¼Œæ¸…ç©ºä¸Šä¸€æ¬¡çš„æ“²éª°ç´€éŒ„
            const fractionPath = `classrooms/${classRoomId}/fraction`;
            database.ref(fractionPath).set(null);

            // æ›´æ–°ç•«é¢
            classroomDisplay.textContent = `æ•™å®¤ä»£ç¢¼: ${classRoomId}`;
            roomEntryContainer.style.display = 'none';
            mainGameContent.style.display = 'block';

            // v5.0.0: å•Ÿå‹•å­¸ç”Ÿç‹€æ…‹ç›£è½å™¨
            listenToStudents();
        }

        // v5.0.0: ç›£è½å­¸ç”Ÿç‹€æ…‹ä¸¦æ›´æ–°å„€è¡¨æ¿
        function listenToStudents() {
            const studentsPath = `classrooms/${classRoomId}/students`;
            database.ref(studentsPath).on('value', (snapshot) => {
                const studentsData = snapshot.val() || {};
                const studentsArray = Object.values(studentsData);
                
                // ä¾å§“åæ’åº
                studentsArray.sort((a, b) => a.name.localeCompare(b.name));

                updateStudentList(studentsArray);
                updateWinnersList(studentsArray);
            });
        }
        
        // v5.0.0: æ›´æ–°å³å´å­¸ç”Ÿåˆ—è¡¨
        function updateStudentList(students) {
            if (students.length === 0) {
                studentListEl.innerHTML = '<p class="text-gray-400 text-center">æ­£åœ¨ç­‰å¾…å­¸ç”ŸåŠ å…¥...</p>';
                return;
            }
            studentListEl.innerHTML = '';
            const statusMap = {
                'æº–å‚™å®Œæˆ': { emoji: 'âœ…', color: 'text-green-600' },
                'è¼¸å…¥ä¸­': { emoji: 'âœï¸', color: 'text-yellow-600' },
                'è³“æœ': { emoji: 'ğŸ†', color: 'text-red-500 font-bold' }
            };
            students.forEach(student => {
                const statusInfo = statusMap[student.status] || { emoji: 'â“', color: 'text-gray-400' };
                const studentDiv = document.createElement('div');
                studentDiv.className = 'flex justify-between items-center p-2 border-b';
                studentDiv.innerHTML = `
                    <span class="font-medium">${student.name}</span>
                    <span class="font-semibold ${statusInfo.color}">${statusInfo.emoji} ${student.status}</span>
                `;
                studentListEl.appendChild(studentDiv);
            });
        }
        
        // v5.0.0: æ›´æ–°å·¦å´è³“æœåˆ—è¡¨ä¸¦è§¸ç™¼æ…¶ç¥
        function updateWinnersList(students) {
            const currentWinners = students.filter(s => s.status === 'è³“æœ');
            if (currentWinners.length === 0) {
                winnersListEl.innerHTML = '<p class="text-gray-400 text-center">ç›®å‰æ²’æœ‰äººè³“æœ...</p>';
                return;
            }
            winnersListEl.innerHTML = '';
            currentWinners.forEach(winner => {
                const winnerDiv = document.createElement('div');
                winnerDiv.className = 'text-center text-xl font-bold p-3 bg-yellow-100 rounded-lg mb-2 animate-pulse';
                winnerDiv.textContent = `ğŸ‰ ${winner.name} ğŸ‰`;
                winnersListEl.appendChild(winnerDiv);

                // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°çš„è³“æœç©å®¶
                if (!celebratedWinners.has(winner.name)) {
                    celebratedWinners.add(winner.name);
                    triggerCelebration(winner.name);
                }
            });
        }

        // v5.0.0: è§¸ç™¼è³“æœæ…¶ç¥å‹•ç•«èˆ‡éŸ³æ•ˆ
        function triggerCelebration(winnerName) {
            celebrationText.textContent = `æ­å–œ ${winnerName} è³“æœï¼`;
            celebrationModal.style.display = 'flex';
            setTimeout(() => celebrationModal.classList.add('visible'), 50);

            bingoSound.currentTime = 0;
            bingoSound.play();

            // å½©å¸¶å‹•ç•«
            const duration = 5 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1001 };
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = 50 * (timeLeft / duration);
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
            }, 250);
        }

        // --- ç¹ªåœ–èˆ‡è¨ˆç®—å‡½å¼ (ç„¡è®Šå‹•) ---
        function createPieSVG(numerator, denominator) {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            const size = 180;
            const center = size / 2;
            const radius = size / 2 - 10;
            svg.setAttribute("viewBox", `0 0 ${size} ${size}`);
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            const angleStep = 360 / denominator;
            let currentAngle = -90;
            for (let i = 0; i < denominator; i++) {
                const startX = center + radius * Math.cos(currentAngle * Math.PI / 180);
                const startY = center + radius * Math.sin(currentAngle * Math.PI / 180);
                currentAngle += angleStep;
                const endX = center + radius * Math.cos(currentAngle * Math.PI / 180);
                const endY = center + radius * Math.sin(currentAngle * Math.PI / 180);
                const largeArcFlag = angleStep > 180 ? 1 : 0;
                const pathData = `M ${center},${center} L ${startX},${startY} A ${radius},${radius} 0 ${largeArcFlag} 1 ${endX},${endY} Z`;
                const path = document.createElementNS(svgNS, "path");
                path.setAttribute("d", pathData);
                path.setAttribute("stroke", "#4b5563");
                path.setAttribute("stroke-width", "1.5");
                path.setAttribute("fill", i < numerator ? "#3b82f6" : "#e5e7eb");
                svg.appendChild(path);
            }
            const container = document.createElement('div');
            container.className = 'flex flex-col items-center';
            container.appendChild(svg);
            const label = document.createElement('div');
            label.className = 'text-2xl font-bold mt-1';
            label.innerHTML = `<div class="fraction"><span>${numerator}</span><span class="denominator">${denominator}</span></div>`;
            container.appendChild(label);
            return container;
        }
        
        // --- æ“²éª°å­å‡½å¼ (ç„¡è®Šå‹•) ---
        function rollDice() {
            rollButton.disabled = true;
            dice1El.classList.add('rolling');
            dice2El.classList.add('rolling');
            rollSound.currentTime = 0;
            rollSound.play();
            let rollCount = 0;
            const interval = setInterval(() => {
                dice1El.textContent = Math.ceil(Math.random() * 10);
                dice2El.textContent = Math.ceil(Math.random() * 10);
                rollCount++;
                if (rollCount > 10) {
                    clearInterval(interval);
                    dice1El.classList.remove('rolling');
                    dice2El.classList.remove('rolling');
                    const num1 = parseInt(dice1El.textContent);
                    const num2 = parseInt(dice2El.textContent);
                    processResult(num1, num2);
                    rollButton.disabled = false;
                }
            }, 100);
        }

        // --- è™•ç†çµæœå‡½å¼ (ç„¡è®Šå‹•) ---
        function processResult(num1, num2) {
            let numerator, denominator;
            if (num1 === num2) {
                numerator = 1;
                denominator = 1;
            } else {
                numerator = Math.min(num1, num2);
                denominator = Math.max(num1, num2);
            }
            if (!classRoomId) {
                alert('éŒ¯èª¤ï¼šæ²’æœ‰æ•™å®¤ä»£ç¢¼ï¼Œç„¡æ³•ç™¼é€åˆ†æ•¸ï¼');
                return;
            }
            const fractionPath = `classrooms/${classRoomId}/fraction`;
            database.ref(fractionPath).set({
                num: numerator,
                den: denominator,
                timestamp: Date.now() 
            });
            if (numerator === denominator) {
                fractionDisplayEl.innerHTML = `<span class="text-blue-600">1 (ä»»æ„)</span>`;
            } else {
                fractionDisplayEl.innerHTML = `<div class="fraction"><span>${numerator}</span><span class="denominator">${denominator}</span></div>`;
            }
            updateHistory(numerator, denominator);
            updateVisualizations(numerator, denominator);
        }

        function updateHistory(num, den) {
            if (history.length === 0) {
                historyContainerEl.innerHTML = '';
            }
             const fractionHTML = `<div class="fraction history-item"><span>${num}</span><span class="denominator">${den}</span></div>`;
            history.push({num, den});
            historyContainerEl.insertAdjacentHTML('beforeend', fractionHTML);
        }

        function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
        
        function updateVisualizations(num, den) {
            visualizationContainerEl.innerHTML = '';
            if (num === den) {
                 visualizationContainerEl.innerHTML = `<div class="col-span-full text-center text-2xl font-bold text-green-600 p-8">ğŸ‰ æ“²åˆ° 1ï¼å­¸ç”Ÿå¯ä»¥ä»»é¸ä¸€æ ¼å¡«å¡—ï¼</div>`;
                 return;
            }
            const simpleNum = num / gcd(num, den);
            const simpleDen = den / gcd(num, den);
            visualizationContainerEl.appendChild(createPieSVG(num, den));
            const denominatorsToCheck = [2, 3, 4, 5, 6, 7, 8, 9, 10];
            for (const d of denominatorsToCheck) {
                if (d === den) continue;
                if ((simpleNum * d) % simpleDen === 0) {
                    const n = (simpleNum * d) / simpleDen;
                    if (n > 0 && n <= d) {
                       visualizationContainerEl.appendChild(createPieSVG(n, d));
                    }
                }
            }
        }
    </script>
</body>
</html>