<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æ•¸è³“æœ v6.0.0 - è€å¸«ç«¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 0.5em;
        }
        .fraction > span { display: block; padding: 0 0.3em; }
        .fraction > span.denominator { border-top: 2px solid currentColor; }
        
        /* --- ğŸ¨ å¯ä¿®æ”¹å€åŸŸï¼šéª°å­å¤–è§€ --- */
        .dice {
            width: 100px; /* éª°å­å¯¬åº¦ */
            height: 100px; /* éª°å­é«˜åº¦ */
            border-radius: 16px; /* éª°å­åœ“è§’ */
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem; /* éª°å­æ–‡å­—å¤§å° */
            font-weight: bold;
            color: #1f2937;
        }
        /* --- ğŸ¨ å¯ä¿®æ”¹å€åŸŸçµæŸ --- */

        /* v6.0.0: æ–°å¢ - Toggle Switch æ¨£å¼ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2563eb;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        @keyframes roll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(15deg) scale(1.05); }
            50% { transform: rotate(-15deg) scale(1.05); }
            75% { transform: rotate(5deg) scale(1.02); }
            100% { transform: rotate(0deg) scale(1); }
        }
        .rolling { animation: roll 0.2s linear infinite; }
        
        #celebration-modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center;
        }
        #celebration-content {
            background-color: white; padding: 2rem; border-radius: 24px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: scale(0.5); opacity: 0;
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        #celebration-modal.visible #celebration-content {
            transform: scale(1); opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="room-entry-container" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-8 text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-6">åˆ†æ•¸è³“æœ - æ•™å®¤è¨­å®š</h1>
            <p class="text-gray-600 mb-4">è«‹ç‚ºæ‚¨çš„æ•™å®¤å‘½åï¼Œä¾‹å¦‚ã€Œ502ã€æˆ–ã€Œé€±ä¸‰æ•¸å­¸ç­ã€ã€‚</p>
            <input type="text" id="room-id-input" placeholder="è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
            <button id="enter-room-btn" class="w-full mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition-transform transform active:scale-95 shadow-md">
                âœ… å»ºç«‹/é€²å…¥æ•™å®¤
            </button>
            <button id="clear-all-data-btn" class="w-full mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg text-lg transition-transform transform active:scale-95 shadow-md">
                ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•™å®¤ç´€éŒ„
            </button>
        </div>
    </div>

    <div id="main-game-content" class="min-h-screen" style="display: none;">
        <div class="flex flex-col md:flex-row h-screen">
            
            <div id="bingo-winners-area" class="w-full md:w-1/4 bg-green-50 p-6 border-r border-gray-200 flex flex-col">
                <h2 class="text-2xl font-bold text-green-700 text-center mb-4">ğŸ† å®Œæˆè³“æœ ğŸ†</h2>
                <div id="winners-list" class="flex-grow bg-white rounded-lg p-4 shadow-inner overflow-y-auto">
                    <p class="text-gray-400 text-center">ç›®å‰æ²’æœ‰äººè³“æœ...</p>
                </div>
            </div>

            <div id="teacher-controls-area" class="w-full md:w-1/2 p-6 md:p-8 flex flex-col items-center justify-start overflow-y-auto">
                <div class="w-full text-center mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold text-blue-600 mb-2">åˆ†æ•¸è³“æœ - è€å¸«ç«¯</h1>
                    <h2 id="classroom-display" class="text-xl font-semibold text-gray-500"></h2>
                </div>

                <div class="w-full max-w-sm mx-auto bg-white rounded-lg shadow p-4 mb-6 flex items-center justify-between">
                    <span class="font-bold text-lg text-gray-700">ğŸ’¡ å­¸ç”Ÿä½œç­”æç¤º</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="hint-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-8 flex-grow items-center">
                    <div class="flex flex-col items-center justify-center space-y-6">
                        <button id="roll-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition-transform transform active:scale-95 shadow-md">
                            ğŸ² æ“²éª°å­
                        </button>
                        <div class="flex items-center space-x-4">
                            <div id="dice1" class="dice">?</div>
                            <div id="dice2" class="dice">?</div>
                        </div>
                        <div id="fraction-display" class="text-7xl md:text-8xl font-bold text-gray-700 h-32 flex items-center"></div>
                    </div>
                    <div id="visualization-container" class="grid grid-cols-2 gap-4 min-h-[300px] border-t md:border-t-0 md:border-l p-4 items-center justify-center">
                        <div class="col-span-full flex items-center justify-center text-gray-400">
                            <p>æ“²å‡ºéª°å­å¾Œï¼Œé€™è£¡æœƒé¡¯ç¤ºç­‰å€¼åˆ†æ•¸çš„åœ–å½¢æç¤º</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="student-status-area" class="w-full md:w-1/4 bg-blue-50 p-6 border-l border-gray-200 flex flex-col">
                <h2 class="text-2xl font-bold text-blue-700 text-center mb-4">ğŸ‘¨â€ğŸ“ æ•™å®¤å­¸ç”Ÿ ğŸ‘©â€ğŸ“</h2>
                <div id="student-list" class="flex-grow bg-white rounded-lg p-4 shadow-inner overflow-y-auto">
                    <p class="text-gray-400 text-center">æ­£åœ¨ç­‰å¾…å­¸ç”ŸåŠ å…¥...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="celebration-modal">
        <div id="celebration-content">
            <img id="celebration-image" src="https://class.kh.edu.tw/sites/26005/upload_file/6/21.png" alt="Bingo!" class="w-64 h-64 mx-auto mb-4">
            <h2 id="celebration-text" class="text-3xl font-bold text-yellow-500"></h2>
            <button id="close-celebration-btn" class="mt-6 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">é—œé–‰</button>
        </div>
    </div>

    <audio id="roll-sound" src="https://taira-komori.net/sound_os2/daily01/rolling_pencil.mp3" preload="auto"></audio>
    <audio id="bingo-sound" src="https://taira-komori.net/sound_os/pre/trumpet1.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // ===== Firebase è¨­å®š =====
        const firebaseConfig = {
          apiKey: "AIzaSyCS-PnLcCou_7-PHWu0i-iQLuZz5dh-Rps",
          authDomain: "fraction-bingo-game.firebaseapp.com",
          projectId: "fraction-bingo-game",
          databaseURL: "https://fraction-bingo-game-default-rtdb.asia-southeast1.firebasedatabase.app",
          storageBucket: "fraction-bingo-game.firebasestorage.app",
          messagingSenderId: "542920141931",
          appId: "1:542920141931:web:999d100aafa817a6ff152e"
        };
        // ========================

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- DOM å…ƒç´  ---
        const roomEntryContainer = document.getElementById('room-entry-container');
        const mainGameContent = document.getElementById('main-game-content');
        const roomIdInput = document.getElementById('room-id-input');
        const enterRoomBtn = document.getElementById('enter-room-btn');
        const classroomDisplay = document.getElementById('classroom-display');
        const rollButton = document.getElementById('roll-button');
        const dice1El = document.getElementById('dice1');
        const dice2El = document.getElementById('dice2');
        const fractionDisplayEl = document.getElementById('fraction-display');
        const visualizationContainerEl = document.getElementById('visualization-container');
        const rollSound = document.getElementById('roll-sound');
        const studentListEl = document.getElementById('student-list');
        const winnersListEl = document.getElementById('winners-list');
        const celebrationModal = document.getElementById('celebration-modal');
        const celebrationText = document.getElementById('celebration-text');
        const closeCelebrationBtn = document.getElementById('close-celebration-btn');
        const bingoSound = document.getElementById('bingo-sound');
        const clearAllDataBtn = document.getElementById('clear-all-data-btn');
        // v6.0.0: æ–°å¢ DOM å…ƒç´ 
        const hintToggle = document.getElementById('hint-toggle');

        // --- éŠæˆ²ç‹€æ…‹ ---
        let classRoomId = null;
        let celebratedWinners = new Set(); 

        // --- äº‹ä»¶ç›£è½ ---
        enterRoomBtn.addEventListener('click', enterRoom);
        rollButton.addEventListener('click', rollDice);
        closeCelebrationBtn.addEventListener('click', () => {
            celebrationModal.classList.remove('visible');
            setTimeout(() => { celebrationModal.style.display = 'none'; }, 300);
        });
        clearAllDataBtn.addEventListener('click', clearAllClassroomData);
        // v6.0.0: æ–°å¢æç¤ºé–‹é—œçš„äº‹ä»¶ç›£è½
        hintToggle.addEventListener('change', toggleHints);

        // --- æ ¸å¿ƒå‡½å¼ ---

        function clearAllClassroomData() {
            const password = prompt("æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰æ•™å®¤çš„éŠæˆ²ç´€éŒ„ï¼\nè«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š");
            if (password === "26005") {
                const confirmation = confirm("å¯†ç¢¼æ­£ç¢ºï¼æ‚¨ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ•™å®¤çš„ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼");
                if (confirmation) {
                    database.ref('classrooms').set(null)
                        .then(() => {
                            alert("æ‰€æœ‰æ•™å®¤ç´€éŒ„å·²æˆåŠŸæ¸…é™¤ï¼");
                        })
                        .catch((error) => {
                            alert("æ¸…é™¤å¤±æ•—ï¼š" + error.message);
                        });
                }
            } else if (password !== null) {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        }

        // v6.0.0: æ–°å¢ - åˆ‡æ›æç¤ºåŠŸèƒ½
        function toggleHints() {
            if (!classRoomId) return;
            const hintsEnabled = hintToggle.checked;
            const settingsPath = `classrooms/${classRoomId}/settings`;
            database.ref(settingsPath).update({ hintsEnabled: hintsEnabled });
        }

        function enterRoom() {
            const roomId = roomIdInput.value.trim();
            if (!roomId) {
                alert('è«‹å‹™å¿…è¼¸å…¥æ•™å®¤ä»£ç¢¼ï¼');
                return;
            }
            classRoomId = roomId;
            
            celebratedWinners = new Set();
            winnersListEl.innerHTML = '<p class="text-gray-400 text-center">ç›®å‰æ²’æœ‰äººè³“æœ...</p>';
            
            const classroomRef = database.ref(`classrooms/${classRoomId}`);
            
            // é€²å…¥æ•™å®¤æ™‚ï¼Œé‡ç½®æ•™å®¤æ‰€æœ‰è³‡æ–™ï¼Œä¸¦è¨­å®šé è¨­å€¼
            classroomRef.set({
                // v6.0.0: é è¨­é–‹å•Ÿæç¤º
                settings: {
                    hintsEnabled: true
                },
                // ä¿ç•™ä¸€å€‹ç©ºçš„ students å’Œ fraction ç¯€é»ï¼Œé¿å…é¦–æ¬¡ç›£è½å‡ºéŒ¯
                students: {}, 
                fraction: null
            }).then(() => {
                // æ›´æ–°ç•«é¢
                classroomDisplay.textContent = `æ•™å®¤ä»£ç¢¼: ${classRoomId}`;
                roomEntryContainer.style.display = 'none';
                mainGameContent.style.display = 'block';
                hintToggle.checked = true; // åŒæ­¥UI

                listenToStudents();
            });
        }

        function listenToStudents() {
            const studentsPath = `classrooms/${classRoomId}/students`;
            database.ref(studentsPath).on('value', (snapshot) => {
                const studentsData = snapshot.val() || {};
                const studentsArray = Object.values(studentsData);
                studentsArray.sort((a, b) => a.name.localeCompare(b.name));
                updateStudentList(studentsArray);
                updateWinnersList(studentsArray);
            });
        }
        
        function updateStudentList(students) {
            if (students.length === 0) {
                studentListEl.innerHTML = '<p class="text-gray-400 text-center">æ­£åœ¨ç­‰å¾…å­¸ç”ŸåŠ å…¥...</p>';
                return;
            }
            studentListEl.innerHTML = '';
            // v6.0.0: æ–°å¢ã€Œç„¡åˆ†æ•¸å¯è¼¸å…¥ã€ç‹€æ…‹
            const statusMap = {
                'æº–å‚™å®Œæˆ': { emoji: 'âœ…', color: 'text-green-600' },
                'è¼¸å…¥ä¸­': { emoji: 'âœï¸', color: 'text-yellow-600' },
                'ç„¡åˆ†æ•¸å¯è¼¸å…¥': { emoji: 'ğŸš«', color: 'text-orange-500' }, // æ–°ç‹€æ…‹
                'è³“æœ': { emoji: 'ğŸ†', color: 'text-red-500 font-bold' }
            };
            students.forEach(student => {
                const statusInfo = statusMap[student.status] || { emoji: 'â“', color: 'text-gray-400' };
                const studentDiv = document.createElement('div');
                studentDiv.className = 'flex justify-between items-center p-2 border-b';
                studentDiv.innerHTML = `
                    <span class="font-medium">${student.name}</span>
                    <span class="font-semibold ${statusInfo.color}">${statusInfo.emoji} ${student.status}</span>
                `;
                studentListEl.appendChild(studentDiv);
            });
        }
        
        function updateWinnersList(students) {
            const currentWinners = students.filter(s => s.status === 'è³“æœ');
            if (currentWinners.length === 0) {
                winnersListEl.innerHTML = '<p class="text-gray-400 text-center">ç›®å‰æ²’æœ‰äººè³“æœ...</p>';
                return;
            }
            winnersListEl.innerHTML = '';
            currentWinners.forEach(winner => {
                const winnerDiv = document.createElement('div');
                winnerDiv.className = 'text-center text-xl font-bold p-3 bg-yellow-100 rounded-lg mb-2 animate-pulse';
                winnerDiv.textContent = `ğŸ‰ ${winner.name} ğŸ‰`;
                winnersListEl.appendChild(winnerDiv);
                if (!celebratedWinners.has(winner.name)) {
                    celebratedWinners.add(winner.name);
                    triggerCelebration(winner.name);
                }
            });
        }

        function triggerCelebration(winnerName) {
            celebrationText.textContent = `æ­å–œ ${winnerName} è³“æœï¼`;
            celebrationModal.style.display = 'flex';
            setTimeout(() => celebrationModal.classList.add('visible'), 50);
            bingoSound.currentTime = 0;
            bingoSound.play();
            const duration = 5 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1001 };
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = 50 * (timeLeft / duration);
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
            }, 250);
        }

        function createPieSVG(numerator, denominator) {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            // --- ğŸ¨ å¯ä¿®æ”¹å€åŸŸï¼šç­‰å€¼åˆ†æ•¸åœ–å½¢å¤§å° ---
            const size = 150; // åœ–å½¢å¤§å°
            const center = size / 2;
            const radius = size / 2 - 10;
            svg.setAttribute("viewBox", `0 0 ${size} ${size}`);
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            const angleStep = 360 / denominator;
            let currentAngle = -90;
            for (let i = 0; i < denominator; i++) {
                const startX = center + radius * Math.cos(currentAngle * Math.PI / 180);
                const startY = center + radius * Math.sin(currentAngle * Math.PI / 180);
                currentAngle += angleStep;
                const endX = center + radius * Math.cos(currentAngle * Math.PI / 180);
                const endY = center + radius * Math.sin(currentAngle * Math.PI / 180);
                const largeArcFlag = angleStep > 180 ? 1 : 0;
                const pathData = `M ${center},${center} L ${startX},${startY} A ${radius},${radius} 0 ${largeArcFlag} 1 ${endX},${endY} Z`;
                const path = document.createElementNS(svgNS, "path");
                path.setAttribute("d", pathData);
                path.setAttribute("stroke", "#4b5563");
                path.setAttribute("stroke-width", "1.5");
                path.setAttribute("fill", i < numerator ? "#3b82f6" : "#e5e7eb");
                svg.appendChild(path);
            }
            const container = document.createElement('div');
            container.className = 'flex flex-col items-center justify-center p-2';
            container.appendChild(svg);
            const label = document.createElement('div');
            label.className = 'text-xl font-bold mt-1';
            label.innerHTML = `<div class="fraction"><span>${numerator}</span><span class="denominator">${denominator}</span></div>`;
            container.appendChild(label);
            return container;
        }
        
        function rollDice() {
            rollButton.disabled = true;
            dice1El.classList.add('rolling');
            dice2El.classList.add('rolling');
            rollSound.currentTime = 0;
            rollSound.play();
            let rollCount = 0;
            const interval = setInterval(() => {
                dice1El.textContent = Math.ceil(Math.random() * 10);
                dice2El.textContent = Math.ceil(Math.random() * 10);
                rollCount++;
                if (rollCount > 10) {
                    clearInterval(interval);
                    dice1El.classList.remove('rolling');
                    dice2El.classList.remove('rolling');
                    const num1 = parseInt(dice1El.textContent);
                    const num2 = parseInt(dice2El.textContent);
                    processResult(num1, num2);
                    rollButton.disabled = false;
                }
            }, 100);
        }

        function processResult(num1, num2) {
            let numerator, denominator;
            if (num1 === num2) {
                numerator = 1; denominator = 1;
            } else {
                numerator = Math.min(num1, num2); denominator = Math.max(num1, num2);
            }
            if (!classRoomId) {
                alert('éŒ¯èª¤ï¼šæ²’æœ‰æ•™å®¤ä»£ç¢¼ï¼Œç„¡æ³•ç™¼é€åˆ†æ•¸ï¼');
                return;
            }
            const fractionPath = `classrooms/${classRoomId}/fraction`;
            database.ref(fractionPath).set({
                num: numerator,
                den: denominator,
                timestamp: Date.now() 
            });
            if (numerator === denominator) {
                fractionDisplayEl.innerHTML = `<span class="text-blue-600">1 (ä»»æ„)</span>`;
            } else {
                fractionDisplayEl.innerHTML = `<div class="fraction"><span>${numerator}</span><span class="denominator">${denominator}</span></div>`;
            }
            updateVisualizations(numerator, denominator);
        }

        function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
        
        function updateVisualizations(num, den) {
            visualizationContainerEl.innerHTML = '';
            if (num === den) {
                 visualizationContainerEl.innerHTML = `<div class="col-span-full text-center text-xl font-bold text-green-600 p-4">ğŸ‰ æ“²åˆ° 1ï¼<br>å­¸ç”Ÿå¯ä»¥ä»»é¸ä¸€æ ¼å¡«å¡—ï¼</div>`;
                 return;
            }
            const simpleNum = num / gcd(num, den);
            const simpleDen = den / gcd(num, den);
            visualizationContainerEl.appendChild(createPieSVG(num, den));
            const denominatorsToCheck = [2, 3, 4, 5, 6, 7, 8, 9, 10];
            let foundCount = 1;
            for (const d of denominatorsToCheck) {
                if (d === den || foundCount >= 4) continue;
                if ((simpleNum * d) % simpleDen === 0) {
                    const n = (simpleNum * d) / simpleDen;
                    if (n > 0 && n <= d) {
                       visualizationContainerEl.appendChild(createPieSVG(n, d));
                       foundCount++;
                    }
                }
            }
            // å¦‚æœæ‰¾ä¸åˆ°ä»»ä½•å…¶ä»–ç­‰å€¼åˆ†æ•¸ï¼Œé¡¯ç¤ºæç¤º
            if (foundCount === 1) {
                 const placeholder = document.createElement('div');
                 placeholder.className = "col-span-full text-center text-gray-500 p-4";
                 placeholder.textContent = "æ²’æœ‰å…¶ä»–å¸¸è¦‹çš„ç­‰å€¼åˆ†æ•¸";
                 visualizationContainerEl.appendChild(placeholder);
            }
        }
    </script>
</body>
</html>